<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ‚é¡µé¢é€‰æ‹©å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .complex-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-element {
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .test-element:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .test-element.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        .dynamic-css {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .debug-panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .selector-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
        }
        .valid { border-left: 4px solid #28a745; }
        .invalid { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="complex-container">
        <h1>ğŸ” å¤æ‚é¡µé¢é€‰æ‹©å™¨æµ‹è¯•</h1>

        <div class="debug-panel">
            <h3>ğŸ¯ é€‰æ‹©å™¨åˆ†æå™¨</h3>
            <div class="selector-display" id="currentSelector">
                <strong>å½“å‰é€‰æ‹©å™¨:</strong> <span id="selectorText">æœªé€‰æ‹©å…ƒç´ </span>
            </div>
            <div class="selector-display" id="strategyInfo">
                <strong>ä½¿ç”¨ç­–ç•¥:</strong> <span id="strategyText">ç­‰å¾…é€‰æ‹©</span>
            </div>
            <button onclick="testCurrentSelector()" class="btn-primary">æµ‹è¯•å½“å‰é€‰æ‹©å™¨</button>
            <button onclick="showAllStrategies()" class="btn-success">æ˜¾ç¤ºæ‰€æœ‰ç­–ç•¥</button>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸ1: åŠ¨æ€CSSç±»å -->
        <div class="test-section">
            <h3>ğŸ“± æµ‹è¯•åŒºåŸŸ1: åŠ¨æ€CSSç±»å (ç±»ä¼¼React/Vue)</h3>
            <div id="app-root" class="css-abc123">
                <div class="container css-def456">
                    <div class="form css-ghi789">
                        <div class="form-group css-jkl012">
                            <label>ç”¨æˆ·å:</label>
                            <input id="username-input" type="text" class="form-control css-mno345 is-focused" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        </div>
                        <div class="form-group css-pqr678">
                            <label>å¯†ç :</label>
                            <input type="password" class="form-control css-stu901" placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                        <button class="btn btn-primary css-vwx234">ç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸ2: å¤æ‚åµŒå¥—ç»“æ„ -->
        <div class="test-section">
            <h3>ğŸ—ï¸ æµ‹è¯•åŒºåŸŸ2: å¤æ‚åµŒå¥—ç»“æ„</h3>
            <div class="dashboard">
                <div class="sidebar">
                    <nav class="menu">
                        <ul class="menu-list">
                            <li class="menu-item active"><a href="#">é¦–é¡µ</a></li>
                            <li class="menu-item"><a href="#">äº§å“</a></li>
                            <li class="menu-item"><a href="#">å…³äº</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="main-content">
                    <div class="widget">
                        <h4 class="widget-title">ç»Ÿè®¡ä¿¡æ¯</h4>
                        <div class="widget-content">
                            <div class="stat-item">
                                <span class="stat-label">ç”¨æˆ·æ•°:</span>
                                <span class="stat-value" data-stat="users">1,234</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è®¢å•æ•°:</span>
                                <span class="stat-value" data-stat="orders">567</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸ3: æ²¡æœ‰ID/ç±»çš„å…ƒç´  -->
        <div class="test-section">
            <h3>ğŸ² æµ‹è¯•åŒºåŸŸ3: æ²¡æœ‰ID/ç±»çš„å…ƒç´ </h3>
            <section>
                <article>
                    <div>
                        <h4>ç¬¬ä¸€ä¸ªæ ‡é¢˜</h4>
                        <p>è¿™æ˜¯ç¬¬ä¸€æ®µå†…å®¹</p>
                    </div>
                    <div>
                        <h4>ç¬¬äºŒä¸ªæ ‡é¢˜</h4>
                        <p>è¿™æ˜¯ç¬¬äºŒæ®µå†…å®¹</p>
                    </div>
                    <div>
                        <h4>ç¬¬ä¸‰ä¸ªæ ‡é¢˜</h4>
                        <p>è¿™æ˜¯ç¬¬ä¸‰æ®µå†…å®¹</p>
                    </div>
                </article>
            </section>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸ4: è¡¨æ ¼å…ƒç´  -->
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•åŒºåŸŸ4: è¡¨æ ¼å…ƒç´ </h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th data-column="name">å§“å</th>
                        <th data-column="age">å¹´é¾„</th>
                        <th data-column="city">åŸå¸‚</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-row="1">
                        <td>å¼ ä¸‰</td>
                        <td>25</td>
                        <td>åŒ—äº¬</td>
                        <td><button class="btn-edit" data-id="1">ç¼–è¾‘</button></td>
                    </tr>
                    <tr data-row="2">
                        <td>æå››</td>
                        <td>30</td>
                        <td>ä¸Šæµ·</td>
                        <td><button class="btn-edit" data-id="2">ç¼–è¾‘</button></td>
                    </tr>
                    <tr data-row="3">
                        <td>ç‹äº”</td>
                        <td>28</td>
                        <td>å¹¿å·</td>
                        <td><button class="btn-edit" data-id="3">ç¼–è¾‘</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentElement = null;
        let allStrategies = [];

        // æ¨¡æ‹ŸCSSé€‰æ‹©å™¨ç­–ç•¥ç”Ÿæˆ
        function generateSelectors(element) {
            const strategies = [];

            // ç­–ç•¥1: IDé€‰æ‹©å™¨
            if (element.id) {
                strategies.push({
                    name: 'IDé€‰æ‹©å™¨',
                    selector: `#${element.id}`,
                    priority: 1
                });
            }

            // ç­–ç•¥2: ç¨³å®šç±»åé€‰æ‹©å™¨
            if (element.className) {
                const classes = element.className.trim().split(/\s+/);
                const stableClasses = classes.filter(cls => {
                    return !(
                        cls.match(/^css-[a-f0-9]+$/) ||
                        cls.match(/[a-f0-9]{6,}/) ||
                        cls.includes('is-focused') ||
                        cls.includes('active') ||
                        cls.includes('hover')
                    );
                });

                if (stableClasses.length > 0) {
                    const tagName = element.tagName.toLowerCase();
                    strategies.push({
                        name: 'ç¨³å®šç±»åé€‰æ‹©å™¨',
                        selector: `${tagName}.${stableClasses.slice(0, 2).join('.')}`,
                        priority: 2
                    });
                }
            }

            // ç­–ç•¥3: å±æ€§é€‰æ‹©å™¨
            const stableAttributes = ['data-testid', 'data-cy', 'name', 'type', 'role', 'data-stat', 'data-row', 'data-id'];
            for (const attr of stableAttributes) {
                const value = element.getAttribute(attr);
                if (value) {
                    const tagName = element.tagName.toLowerCase();
                    strategies.push({
                        name: `å±æ€§é€‰æ‹©å™¨ (${attr})`,
                        selector: `${tagName}[${attr}="${value}"]`,
                        priority: 3
                    });
                    break;
                }
            }

            // ç­–ç•¥4: nth-childé€‰æ‹©å™¨
            if (element.parentNode) {
                const siblings = Array.from(element.parentNode.children);
                const index = siblings.indexOf(element) + 1;
                const tagName = element.tagName.toLowerCase();
                strategies.push({
                    name: 'nth-childé€‰æ‹©å™¨',
                    selector: `${tagName}:nth-child(${index})`,
                    priority: 4
                });
            }

            // ç­–ç•¥5: æ–‡æœ¬å†…å®¹é€‰æ‹©å™¨
            const text = element.textContent?.trim();
            if (text && text.length < 50 && text.match(/^[a-zA-Z0-9\u4e00-\u9fa5\s\-_,.]+$/)) {
                const tagName = element.tagName.toLowerCase();
                strategies.push({
                    name: 'æ–‡æœ¬å†…å®¹é€‰æ‹©å™¨',
                    selector: `${tagName}[text="${text}"]`,
                    priority: 5
                });
            }

            // æŒ‰ä¼˜å…ˆçº§æ’åº
            strategies.sort((a, b) => a.priority - b.priority);
            return strategies;
        }

        // éªŒè¯é€‰æ‹©å™¨
        function validateSelector(selector, targetElement) {
            try {
                // ç‰¹æ®Šå¤„ç†æ–‡æœ¬é€‰æ‹©å™¨
                if (selector.includes('[text=')) {
                    return validateTextSelector(selector, targetElement);
                }

                const elements = document.querySelectorAll(selector);
                return elements.length === 1 && elements[0] === targetElement;
            } catch (error) {
                return false;
            }
        }

        // éªŒè¯æ–‡æœ¬é€‰æ‹©å™¨
        function validateTextSelector(selector, targetElement) {
            try {
                const match = selector.match(/^(.+)\[text="([^"]+)"\]$/);
                if (!match) return false;

                const [, tagName, text] = match;
                const elements = document.querySelectorAll(tagName);
                for (const element of elements) {
                    if (element.textContent?.trim() === text && element === targetElement) {
                        return true;
                    }
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // é€‰æ‹©å…ƒç´ 
        function selectElement(element) {
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            currentElement = element;

            // ç”Ÿæˆé€‰æ‹©å™¨ç­–ç•¥
            allStrategies = generateSelectors(element);

            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„é€‰æ‹©å™¨
            let validSelector = null;
            let usedStrategy = null;

            for (const strategy of allStrategies) {
                if (validateSelector(strategy.selector, element)) {
                    validSelector = strategy.selector;
                    usedStrategy = strategy.name;
                    break;
                }
            }

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('selectorText').textContent = validSelector || 'æ— æœ‰æ•ˆé€‰æ‹©å™¨';
            document.getElementById('strategyText').textContent = usedStrategy || 'æ— å¯ç”¨ç­–ç•¥';

            const selectorDiv = document.getElementById('currentSelector');
            selectorDiv.className = 'selector-display ' + (validSelector ? 'valid' : 'invalid');

            // å‘é€è°ƒè¯•ä¿¡æ¯
            try {
                window.postMessage({
                    type: 'DOM_WATCHER_DEBUG',
                    selector: validSelector,
                    element: element.tagName.toLowerCase(),
                    strategies: allStrategies
                }, '*');
            } catch (error) {
                console.warn('å‘é€è°ƒè¯•ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•å½“å‰é€‰æ‹©å™¨
        function testCurrentSelector() {
            const selector = document.getElementById('selectorText').textContent;
            if (!selector || selector === 'æœªé€‰æ‹©å…ƒç´ ') {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
                return;
            }

            const isValid = validateSelector(selector, currentElement);
            alert(`é€‰æ‹©å™¨ "${selector}" ${isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`);
        }

        // æ˜¾ç¤ºæ‰€æœ‰ç­–ç•¥
        function showAllStrategies() {
            if (allStrategies.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
                return;
            }

            let message = 'æ‰€æœ‰é€‰æ‹©å™¨ç­–ç•¥:\n\n';
            allStrategies.forEach((strategy, index) => {
                const isValid = validateSelector(strategy.selector, currentElement);
                message += `${index + 1}. ${strategy.name} (ä¼˜å…ˆçº§: ${strategy.priority})\n`;
                message += `   é€‰æ‹©å™¨: ${strategy.selector}\n`;
                message += `   çŠ¶æ€: ${isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}\n\n`;
            });

            alert(message);
        }

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.addEventListener('click', function(e) {
            // å¿½ç•¥æŒ‰é’®ç‚¹å‡»
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
            }

            // å¿½ç•¥è°ƒè¯•é¢æ¿ç‚¹å‡»
            if (e.target.closest('.debug-panel')) {
                return;
            }

            selectElement(e.target);
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¤æ‚é¡µé¢æµ‹è¯•å·²åŠ è½½');
            console.log('ç‚¹å‡»ä»»ä½•å…ƒç´ æ¥æµ‹è¯•é€‰æ‹©å™¨ç”Ÿæˆ');
        });

        // å…¨å±€å‡½æ•°ä¾›è°ƒè¯•ä½¿ç”¨
        window.testCurrentSelector = testCurrentSelector;
        window.showAllStrategies = showAllStrategies;
        window.allStrategies = allStrategies;
    </script>
</body>
</html>