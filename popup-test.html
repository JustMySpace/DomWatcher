<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMå±æ€§ç›‘å¬å™¨ - æµ‹è¯•</title>
    <style>
        body {
            width: 350px;
            height: 400px;
            margin: 0;
            padding: 16px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            background-color: #f5f5f5;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            background-color: #2196F3;
            color: white;
        }

        button:hover {
            background-color: #1976d2;
        }

        .status {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .log {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸ” DOMç›‘å¬å™¨æµ‹è¯•</h2>
    </div>

    <div class="status" id="status">
        ç­‰å¾…æµ‹è¯•...
    </div>

    <button id="testButton">æµ‹è¯•æŒ‰é’®</button>
    <button id="testCommunication">æµ‹è¯•é€šä¿¡</button>
    <button id="testCapture">æµ‹è¯•å…ƒç´ é€‰æ‹©</button>

    <div class="log" id="log">
        ç­‰å¾…æ—¥å¿—...
    </div>

    <script>
        console.log('æµ‹è¯•popupè„šæœ¬å¼€å§‹åŠ è½½');

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
            console.log('çŠ¶æ€æ›´æ–°:', text);
        }

        function addLog(text) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML = `[${timestamp}] ${text}<br>` + log.innerHTML;
            console.log('æ—¥å¿—:', text);
        }

        function getCurrentTabId() {
            return new Promise((resolve, reject) => {
                chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else {
                        resolve(tabs[0].id);
                    }
                });
            });
        }

        function sendMessage(tabId, action, data = {}) {
            return new Promise((resolve, reject) => {
                chrome.tabs.sendMessage(tabId, {
                    action: action,
                    ...data
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else {
                        resolve(response || {});
                    }
                });
            });
        }

        // DOMåŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            updateStatus('åˆå§‹åŒ–ä¸­...');
            addLog('DOMåŠ è½½å®Œæˆ');

            try {
                const tabId = await getCurrentTabId();
                addLog(`è·å–åˆ°æ ‡ç­¾ID: ${tabId}`);
                updateStatus('åˆå§‹åŒ–æˆåŠŸ');

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('testButton').addEventListener('click', () => {
                    addLog('æµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»');
                    updateStatus('æµ‹è¯•æŒ‰é’®ç‚¹å‡»æˆåŠŸ');
                });

                document.getElementById('testCommunication').addEventListener('click', async () => {
                    try {
                        addLog('å¼€å§‹æµ‹è¯•é€šä¿¡...');
                        const response = await sendMessage(tabId, 'getStatus');
                        addLog('é€šä¿¡æµ‹è¯•æˆåŠŸ: ' + JSON.stringify(response));
                        updateStatus('é€šä¿¡æµ‹è¯•æˆåŠŸ');
                    } catch (error) {
                        addLog('é€šä¿¡æµ‹è¯•å¤±è´¥: ' + error.message);
                        updateStatus('é€šä¿¡æµ‹è¯•å¤±è´¥');
                    }
                });

                document.getElementById('testCapture').addEventListener('click', async () => {
                    try {
                        addLog('å¼€å§‹æµ‹è¯•å…ƒç´ é€‰æ‹©...');
                        const response = await sendMessage(tabId, 'startCapture');
                        addLog('å…ƒç´ é€‰æ‹©æµ‹è¯•: ' + JSON.stringify(response));
                        updateStatus('å…ƒç´ é€‰æ‹©æµ‹è¯•å®Œæˆ');
                    } catch (error) {
                        addLog('å…ƒç´ é€‰æ‹©æµ‹è¯•å¤±è´¥: ' + error.message);
                        updateStatus('å…ƒç´ é€‰æ‹©æµ‹è¯•å¤±è´¥');
                    }
                });

            } catch (error) {
                addLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                updateStatus('åˆå§‹åŒ–å¤±è´¥');
            }
        });

        console.log('æµ‹è¯•popupè„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>